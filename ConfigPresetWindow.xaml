<Window x:Class="PackageManager.ConfigPresetWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:controls="clr-namespace:CustomControlLibrary.CustomControl.Controls;assembly=CustomControlLibrary"
        xmlns:button="clr-namespace:CustomControlLibrary.CustomControl.Controls.Button;assembly=CustomControlLibrary"
        xmlns:models="clr-namespace:PackageManager.Models"
        xmlns:local="clr-namespace:PackageManager"
        Title="切换配置" Height="560" Width="1000"
        ResizeMode="CanResize" WindowStartupLocation="CenterOwner" Loaded="Window_Loaded">
    <Window.Resources>
        <local:UrlWrapConverter x:Key="UrlWrapConverter"/>
    </Window.Resources>
    <Grid Margin="20">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
            <RowDefinition Height="Auto"/>
        </Grid.RowDefinitions>

        <!-- 标题 -->
        <TextBlock Grid.Row="0" Text="请选择要应用的预设配置" FontSize="18" FontWeight="Bold"/>

        <!-- 可滚动的统一卡片列表（内置 + 自定义 + 添加占位，保持添加在最后） -->
        <ScrollViewer Grid.Row="1" VerticalScrollBarVisibility="Auto" HorizontalScrollBarVisibility="Disabled" Margin="0,12,0,12">
            <ItemsControl ItemsSource="{Binding PresetItems}">
                <ItemsControl.ItemsPanel>
                    <ItemsPanelTemplate>
                        <WrapPanel />
                    </ItemsPanelTemplate>
                </ItemsControl.ItemsPanel>
                <ItemsControl.Resources>
                <!-- 配置卡片模板：统一宽度与高度，内置项不显示右键菜单 -->
                <DataTemplate DataType="{x:Type models:ConfigPreset}">
                    <Border x:Name="CardBorder" BorderBrush="#DDD" BorderThickness="1" Padding="10" Margin="0,0,10,10" Width="280" Height="220" ContextMenuOpening="PresetCard_ContextMenuOpening">
                        <StackPanel>
                            <controls:CRadioButton GroupName="PresetGroup" Content="{Binding Name}" Tag="{Binding}" IsChecked="{Binding IsSelected, Mode=TwoWay}" Checked="PresetRadio_Checked" Margin="0,0,0,8"/>
                            <TextBlock Text="[ServerInfo]" FontFamily="Consolas" FontSize="14"/>
                            <TextBlock FontFamily="Consolas" FontSize="14" TextWrapping="Wrap">
                                <TextBlock.Text>
                                    <Binding Path="ServerDomain" Converter="{StaticResource UrlWrapConverter}" StringFormat='ServerDomain="{0}"' />
                                </TextBlock.Text>
                            </TextBlock>
                            <TextBlock FontFamily="Consolas" FontSize="14" TextWrapping="Wrap">
                                <TextBlock.Text>
                                    <Binding Path="CommonServerDomain" Converter="{StaticResource UrlWrapConverter}" StringFormat='CommonServerDomain="{0}"' />
                                </TextBlock.Text>
                            </TextBlock>
                            <TextBlock FontFamily="Consolas" FontSize="14">
                                <TextBlock.Text>
                                    <Binding Path="IEProxyAvailable" StringFormat='IEProxyAvailable="{0}"' />
                                </TextBlock.Text>
                            </TextBlock>
                            <TextBlock Text="[LoginSetting]" FontFamily="Consolas" FontSize="14" Margin="0,8,0,0"/>
                            <TextBlock FontFamily="Consolas" FontSize="14">
                                <TextBlock.Text>
                                    <Binding Path="requestTimeout" StringFormat='requestTimeout={0}' />
                                </TextBlock.Text>
                            </TextBlock>
                            <TextBlock FontFamily="Consolas" FontSize="14">
                                <TextBlock.Text>
                                    <Binding Path="responseTimeout" StringFormat='responseTimeout={0}' />
                                </TextBlock.Text>
                            </TextBlock>
                            <TextBlock FontFamily="Consolas" FontSize="14">
                                <TextBlock.Text>
                                    <Binding Path="requestRetryTimes" StringFormat='requestRetryTimes={0}' />
                                </TextBlock.Text>
                            </TextBlock>
                        </StackPanel>
                        <Border.ContextMenu>
                            <ContextMenu>
                                <MenuItem Header="删除此自定义配置" Click="DeletePresetMenuItem_Click"/>
                            </ContextMenu>
                        </Border.ContextMenu>
                    </Border>
                </DataTemplate>
                <!-- 添加卡片模板：始终置于最后 -->
                <DataTemplate DataType="{x:Type local:AddCardPlaceholder}">
                    <Border BorderBrush="#DDD" BorderThickness="1" Padding="10" Margin="0,0,10,10" Width="280" Height="220" Background="#F9F9F9" MouseLeftButtonUp="AddPresetCard_MouseLeftButtonUp" Cursor="Hand">
                        <StackPanel HorizontalAlignment="Center" VerticalAlignment="Center">
                            <TextBlock Text="+" FontSize="32" FontWeight="Bold" HorizontalAlignment="Center"/>
                            <TextBlock Text="添加自定义配置" Margin="0,8,0,0" FontSize="14" HorizontalAlignment="Center"/>
                        </StackPanel>
                    </Border>
                </DataTemplate>
                </ItemsControl.Resources>
            </ItemsControl>
        </ScrollViewer>

        <!-- 底部操作 -->
        <StackPanel Grid.Row="2" Orientation="Horizontal" HorizontalAlignment="Right">
            <button:CButton Content="应用" Width="100" Margin="0,0,10,0" Click="ApplyButton_Click"/>
            <button:CButton Content="取消" Width="100" Click="CancelButton_Click"/>
        </StackPanel>
    </Grid>
</Window>