<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>迭代看板</title>
  <style>
    html,body{height:100%;margin:0;padding:0;background:#ffffff;font-family:'Segoe UI','Microsoft YaHei',Arial,sans-serif;}
    .board{display:grid;grid-template-columns:repeat(6,1fr);gap:16px;padding:12px;}
    .column{border:1px solid #E5E7EB;border-radius:10px;background:#F9FAFB;display:flex;flex-direction:column;min-width:220px;max-height:calc(100vh - 120px);}
    .col-header{padding:10px;border-bottom:1px solid #E5E7EB;background:#F9FAFB;}
    .col-title{font-weight:600;font-size:14px;color:#111827;}
    .col-meta{color:#6B7280;font-size:12px;margin-top:4px;}
    .cards{flex:1;overflow-y:auto;padding:8px;}
    .cards::-webkit-scrollbar{width:0;height:0} .cards{scrollbar-width:none;-ms-overflow-style:none}
    .card{display:block;text-decoration:none;background:#fff;border:1px solid #E5E7EB;border-radius:10px;padding:10px;margin-bottom:10px;box-shadow:0 1px 4px rgba(0,0,0,.08);transition:all .15s ease;}
    .card:hover{transform:translateY(-2px);box-shadow:0 4px 12px rgba(0,0,0,.14)}
    .card.in-progress{background:#FFFBEB}
    .card.completed{background:#ECFDF5}
    .card.closed{background:#F3F4F6;opacity:.85}
    .title{font-weight:600;font-size:13px;color:#111827;margin-bottom:8px;display:flex;align-items:center}
    .row{display:flex;align-items:center;gap:6px;color:#6B7280;font-size:12px;margin-top:4px;flex-wrap:wrap}
    .badge{display:inline-flex;align-items:center;border-radius:999px;padding:2px 8px;font-size:12px;font-weight:600}
    .badge.primary{background:#2563EB;color:#fff}
    .badge.warn{background:#F59E0B;color:#fff}
    .badge.muted{background:#E5E7EB;color:#374151}
    .dot{width:10px;height:10px;border-radius:50%;display:inline-block;margin-right:6px}
    .dot.in-progress{background:#F59E0B}
    .dot.completed{background:#10B981}
    .dot.closed{background:#9CA3AF}
    .dot.todo{background:#EF4444}
    .dot.testing{background:#A855F7}
    .dot.testable{background:#3B82F6}
    .modal-backdrop{position:fixed;left:0;top:0;right:0;bottom:0;background:rgba(0,0,0,.5);display:none;align-items:center;justify-content:center;z-index:9999}
    .modal{width:90vw;max-width:1100px;max-height:90vh;background:#fff;border-radius:10px;box-shadow:0 10px 25px rgba(0,0,0,.25);display:flex;flex-direction:column;overflow:hidden}
    .modal-header{display:flex;align-items:center;justify-content:space-between;padding:12px 16px;border-bottom:1px solid #E5E7EB}
    .modal-title{font-weight:600;font-size:16px;color:#111827}
    .modal-close{border:none;background:#F3F4F6;color:#111827;border-radius:6px;padding:6px 10px;cursor:pointer}
    .modal-body{display:grid;grid-template-columns:2fr 1fr;gap:16px;padding:16px;overflow:auto}
    .section{border:1px solid #E5E7EB;border-radius:8px;padding:12px;background:#FAFAFA}
    .section h3{margin:0 0 8px 0;font-size:14px;color:#111827}
    .kv{display:grid;grid-template-columns:120px 1fr;gap:6px;margin-top:6px;font-size:13px;color:#374151}
    .tags{display:flex;flex-wrap:wrap;gap:6px}
    .tag{background:#E5E7EB;color:#374151;border-radius:999px;padding:2px 8px;font-size:12px}
    .img-wrap img{max-width:100%;border-radius:6px;border:1px solid #E5E7EB}
    .comment{border-top:1px dashed #E5E7EB;padding-top:8px;margin-top:8px}
    .comment .meta{font-size:12px;color:#6B7280;margin-bottom:6px}
  </style>
</head>
<body>
  <div id="root" class="board"></div>
  <div id="detailsOverlay" class="modal-backdrop">
    <div class="modal">
      <div class="modal-header">
        <div class="modal-title" id="detailsTitle"></div>
        <button class="modal-close" id="detailsClose">返回看板</button>
      </div>
      <div class="modal-body">
        <div class="section">
          <h3>基本信息</h3>
          <div class="kv"><div>负责人</div><div id="dAssignee"></div></div>
          <div class="kv"><div>状态</div><div id="dState"></div></div>
          <div class="kv"><div>开始时间</div><div id="dStart"></div></div>
          <div class="kv"><div>结束时间</div><div id="dEnd"></div></div>
          <div class="kv"><div>优先级</div><div id="dPriority"></div></div>
          <div class="kv"><div>严重程度</div><div id="dSeverity"></div></div>
          <div class="kv"><div>故事点</div><div id="dPoints"></div></div>
          <div class="kv"><div>所属产品</div><div id="dProduct"></div></div>
          <div class="kv"><div>缺陷类别</div><div id="dDefect"></div></div>
          <div class="kv"><div>复现版本号</div><div id="dVersion"></div></div>
          <div class="kv"><div>复现概率</div><div id="dProb"></div></div>
          <div class="kv"><div>标签</div><div class="tags" id="dTags"></div></div>
          <div class="kv"><div>描述</div><div id="dDesc"></div></div>
          <div class="kv"><div>预期结果</div><div id="dExpect"></div></div>
        </div>
        <div class="section">
          <h3>示意图</h3>
          <div class="img-wrap" id="dSketch"></div>
          <h3 style="margin-top:12px">评论</h3>
          <div id="dComments"></div>
        </div>
      </div>
    </div>
  </div>
  <script>
    const root = document.getElementById('root');
    const overlay = document.getElementById('detailsOverlay');
    const closeBtn = document.getElementById('detailsClose');
    const ORDER_DEFAULT = ["未开始","进行中","可测试","测试中","已完成","已关闭"];
    function fmtPoints(n){
      const r = Math.round((Number(n) + Number.EPSILON) * 10) / 10;
      return Number.isInteger(r) ? String(r) : r.toFixed(1);
    }
    function groupByCategory(items){
      const map = new Map();
      for(const it of items){
        const k = (it.category || "未开始");
        if(!map.has(k)) map.set(k, []);
        map.get(k).push(it);
      }
      return map;
    }
    function dotClass(cat){
      if(cat==="进行中") return "in-progress";
      if(cat==="已完成") return "completed";
      if(cat==="已关闭") return "closed";
      if(cat==="测试中") return "testing";
      if(cat==="可测试") return "testable";
      return "todo";
    }
    function cardClass(cat){
      if(cat==="进行中") return "in-progress";
      if(cat==="已完成") return "completed";
      if(cat==="已关闭") return "closed";
      return "";
    }
    function renderBoard(payload){
      root.innerHTML = "";
      const order = Array.isArray(payload.order) && payload.order.length ? payload.order : ORDER_DEFAULT;
      const grouped = groupByCategory(payload.items || []);
      for(const cat of order){
        const list = grouped.get(cat) || [];
        const col = document.createElement('div');
        col.className = 'column';
        const header = document.createElement('div');
        header.className = 'col-header';
        const title = document.createElement('div');
        title.className = 'col-title';
        title.textContent = cat;
        const meta = document.createElement('div');
        meta.className = 'col-meta';
        const totalPoints = list.reduce((s,a)=>s+(Number(a.storyPoints)||0),0);
        meta.textContent = `数量 · ${list.length}  ·  故事点 · ${fmtPoints(totalPoints)}`;
        header.appendChild(title);
        header.appendChild(meta);
        col.appendChild(header);
        const cards = document.createElement('div');
        cards.className = 'cards';
        for(const it of list){
          const href = (it.htmlUrl && it.htmlUrl.trim())
            ? it.htmlUrl
            : ((payload.linkTemplate && payload.linkTemplate!=="#")
              ? payload.linkTemplate.replace("{id}", it.id||"")
              : "#");
          const a = document.createElement('a');
          a.href = href;
          a.target = "_self";
          a.className = `card ${cardClass(cat)}`;
          if (window.chrome && window.chrome.webview) {
            a.addEventListener('click', function(ev){
              try{
                ev.preventDefault();
                window.chrome.webview.postMessage({type:'open-details', id: it.id});
              }catch(e){}
            });
          }
          const titleRow = document.createElement('div');
          titleRow.className = 'title';
          const dot = document.createElement('span');
          dot.className = `dot ${dotClass(cat)}`;
          titleRow.appendChild(dot);
          titleRow.appendChild(document.createTextNode(it.title || it.id || ""));
          a.appendChild(titleRow);
          const r1 = document.createElement('div');
          r1.className = 'row';
          const typeBadge = document.createElement('span');
          typeBadge.className = 'badge primary';
          typeBadge.textContent = (it.type && it.type.trim()) ? it.type : '需求';
          const prioBadge = document.createElement('span');
          prioBadge.className = 'badge warn';
          prioBadge.textContent = (it.priority && it.priority.trim()) ? it.priority : '普通';
          r1.appendChild(typeBadge);
          r1.appendChild(prioBadge);
          a.appendChild(r1);
          const r2 = document.createElement('div');
          r2.className = 'row';
          const owner = document.createElement('span');
          owner.textContent = `负责人 · ${it.assigneeName || '未指派'}`;
          const points = document.createElement('span');
          points.textContent = `故事点 · ${fmtPoints(it.storyPoints || 0)}`;
          r2.appendChild(owner);
          r2.appendChild(points);
          a.appendChild(r2);
          const r3 = document.createElement('div');
          r3.className = 'row';
          const statusBadge = document.createElement('span');
          statusBadge.className = 'badge muted';
          statusBadge.textContent = it.status || cat;
          r3.appendChild(statusBadge);
          a.appendChild(r3);
          cards.appendChild(a);
        }
        col.appendChild(cards);
        root.appendChild(col);
      }
    }
    function onMessage(ev){
      try{
        const data = ev.data || null;
        if(!data) return;
        if(data.type === 'data'){
          renderBoard(data);
        }else if(data.type === 'details'){
          showDetails(data.data || {});
        }else if(typeof data === 'string'){
          const obj = JSON.parse(data);
          if(obj && obj.type === 'data'){
            renderBoard(obj);
          }else if(obj && obj.type === 'details'){
            showDetails(obj.data || {});
          }
        }
      }catch(e){}
    }
    function toDateStr(v){
      if(!v) return '';
      try{
        const dt = new Date(v);
        if(!isNaN(dt.getTime())){
          const y = dt.getFullYear();
          const m = String(dt.getMonth()+1).padStart(2,'0');
          const d = String(dt.getDate()).padStart(2,'0');
          const hh = String(dt.getHours()).padStart(2,'0');
          const mm = String(dt.getMinutes()).padStart(2,'0');
          return `${y}-${m}-${d} ${hh}:${mm}`;
        }
      }catch(e){}
      return String(v);
    }
    function showDetails(d){
      document.getElementById('detailsTitle').textContent = d.title || d.identifier || d.id || '';
      document.getElementById('dAssignee').textContent = d.assigneeName || '';
      document.getElementById('dState').textContent = d.stateName || d.stateType || '';
      document.getElementById('dStart').textContent = toDateStr(d.startAt || '');
      document.getElementById('dEnd').textContent = toDateStr(d.endAt || '');
      document.getElementById('dPriority').textContent = d.priorityName || '';
      document.getElementById('dSeverity').textContent = d.severityName || '';
      document.getElementById('dPoints').textContent = fmtPoints(d.storyPoints || 0);
      document.getElementById('dProduct').textContent = d.productName || '';
      document.getElementById('dDefect').textContent = d.defectCategory || '';
      document.getElementById('dVersion').textContent = d.reproduceVersion || '';
      document.getElementById('dProb').textContent = d.reproduceProbability || '';
      const tagsEl = document.getElementById('dTags');
      tagsEl.innerHTML = '';
      const tags = Array.isArray(d.tags) ? d.tags : [];
      for(const t of tags){
        const sp = document.createElement('span');
        sp.className = 'tag';
        sp.textContent = t;
        tagsEl.appendChild(sp);
      }
      const sketchEl = document.getElementById('dSketch');
      sketchEl.innerHTML = d.sketcHtml || d.sketc_html || d.sketchHtml || '';
      document.getElementById('dDesc').innerHTML = d.descriptionHtml || '';
      document.getElementById('dExpect').innerHTML = d.expectedResult || '';
      const cEl = document.getElementById('dComments');
      cEl.innerHTML = '';
      const cmts = Array.isArray(d.comments) ? d.comments : [];
      for(const c of cmts){
        const div = document.createElement('div');
        div.className = 'comment';
        const meta = document.createElement('div');
        meta.className = 'meta';
        meta.textContent = `${c.authorName || ''} · ${toDateStr(c.createdAt || '')}`;
        const body = document.createElement('div');
        body.innerHTML = c.contentHtml || '';
        div.appendChild(meta);
        div.appendChild(body);
        cEl.appendChild(div);
      }
      overlay.style.display = 'flex';
    }
    closeBtn.addEventListener('click', function(){
      overlay.style.display = 'none';
    });
    document.addEventListener('keydown', function(e){
      if(e.key === 'Escape') overlay.style.display = 'none';
    }, true);
    if (window.chrome && window.chrome.webview) {
      window.chrome.webview.addEventListener('message', onMessage);
      window.chrome.webview.postMessage({type:'ready'});
    } else {
      renderBoard({order:ORDER_DEFAULT, items:[]});
    }
  </script>
</body>
</html>
