<Page x:Class="PackageManager.Views.PackagesHomePage"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             xmlns:C="clr-namespace:CustomControlLibrary.CustomControl.Controls.DataGrid;assembly=CustomControlLibrary"
             xmlns:controls="clr-namespace:CustomControlLibrary.CustomControl.Controls;assembly=CustomControlLibrary"
             xmlns:button="clr-namespace:CustomControlLibrary.CustomControl.Controls.Button;assembly=CustomControlLibrary"
             mc:Ignorable="d">
    <Grid>
        <Grid.ColumnDefinitions>
            <ColumnDefinition Width="*" />
            <ColumnDefinition Width="6" />
            <ColumnDefinition Width="515" />
        </Grid.ColumnDefinitions>

        <!-- 包列表：继承 MainWindow 的 DataContext 进行绑定 -->
        <C:CDataGrid x:Name="PackageDataGrid"
                     Grid.Column="0"
                     EnableAutoTemplateSelection="True"
                     ItemsSource="{Binding Packages}"
                     SelectedItem="{Binding LatestActivePackage, Mode=TwoWay}" />

        <GridSplitter Grid.Column="1"
                      Width="6"
                      HorizontalAlignment="Stretch"
                      VerticalAlignment="Stretch"
                      Background="#22000000" />

        <!-- 右侧操作面板：吸顶状态提示 + 空态 -->
        <Border x:Name="RightOperationPanel" Grid.Column="2" BorderBrush="#1F000000" BorderThickness="1" Padding="0">
            <Grid>
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="*"/>
                    <RowDefinition Height="Auto"/>
                </Grid.RowDefinitions>

                <!-- 吸顶状态提示（Sticky Header） -->
                <Border Grid.Row="0" Background="#0D000000" Padding="12" BorderBrush="#1F000000" BorderThickness="0,0,0,1">
                    <StackPanel>
                        <controls:CTextBlock Text="{Binding LatestActivePackage.ProductName, TargetNullValue=未选择产品包}" FontSize="16" FontWeight="SemiBold"/>
                        <StackPanel Orientation="Horizontal" Margin="0,6,0,0">
                            <controls:CTextBlock Text="状态:" Foreground="#6B6B6B" Margin="0,0,8,0"/>
                            <controls:CTextBlock Text="{Binding LatestActivePackage.StatusText, FallbackValue=就绪, TargetNullValue=就绪}"/>
                        </StackPanel>
                    </StackPanel>
                </Border>

                <!-- 滚动内容区：当有选中包时显示操作控件 -->
                <ScrollViewer Grid.Row="1" VerticalScrollBarVisibility="Auto" Padding="12">
                    <StackPanel>
                        <!-- 空态占位：未选择包时可见 -->
                        <StackPanel>
                            <StackPanel.Style>
                                <Style TargetType="StackPanel">
                                    <Setter Property="Visibility" Value="Collapsed"/>
                                    <Style.Triggers>
                                        <DataTrigger Binding="{Binding LatestActivePackage}" Value="{x:Null}">
                                            <Setter Property="Visibility" Value="Visible"/>
                                        </DataTrigger>
                                    </Style.Triggers>
                                </Style>
                            </StackPanel.Style>
                            <Border Background="#06000000" Padding="16" CornerRadius="8" BorderBrush="#12000000" BorderThickness="1">
                                <StackPanel>
                                    <controls:CTextBlock Text="未选择产品包" FontSize="16" FontWeight="SemiBold"/>
                                    <controls:CTextBlock Text="请在左侧选择产品分类及包列表项以进行操作" Margin="0,6,0,0" Foreground="#6B6B6B"/>
                                </StackPanel>
                            </Border>
                        </StackPanel>

                        <!-- 操作区：选择包后可见 -->
                        <StackPanel>
                            <StackPanel.Style>
                                <Style TargetType="StackPanel">
                                    <Setter Property="Visibility" Value="Visible"/>
                                    <Style.Triggers>
                                        <DataTrigger Binding="{Binding LatestActivePackage}" Value="{x:Null}">
                                            <Setter Property="Visibility" Value="Collapsed"/>
                                        </DataTrigger>
                                    </Style.Triggers>
                                </Style>
                            </StackPanel.Style>
                            <StackPanel Orientation="Horizontal" Margin="0,0,0,0">
                                <controls:CTextBlock Text="版本" Width="80" VerticalAlignment="Center" />
                                <controls:CComboBox ItemsSource="{Binding LatestActivePackage.AvailableVersions}"
                                                    SelectedItem="{Binding LatestActivePackage.Version, Mode=TwoWay}" Width="320" />
                            </StackPanel>
                            <StackPanel Orientation="Horizontal" Margin="0,8,0,0">
                                <controls:CTextBlock Text="包名" Width="80" VerticalAlignment="Center" />
                                <controls:CComboBox ItemsSource="{Binding LatestActivePackage.AvailablePackages}"
                                                    SelectedItem="{Binding LatestActivePackage.UploadPackageName, Mode=TwoWay}" Width="320" />
                            </StackPanel>
                            <StackPanel Orientation="Horizontal" Margin="0,8,0,0">
                                <controls:CTextBlock Text="可执行版本" Width="80" VerticalAlignment="Center" />
                                <controls:CComboBox ItemsSource="{Binding LatestActivePackage.AvailableExecutableVersions}"
                                                    DisplayMemberPath="DisPlayName"
                                                    SelectedValuePath="DisPlayName"
                                                    SelectedValue="{Binding LatestActivePackage.SelectedExecutableVersion, Mode=TwoWay}" Width="320" />
                            </StackPanel>
                            <StackPanel Orientation="Horizontal" Margin="0,16,0,0">
                                <button:CButton Content="{Binding LatestActivePackage.UnlockUpdateButtonText}" Command="{Binding LatestActivePackage.UnlockUpdateToggleCommand}" Width="80" Margin="0,0,8,0" IsEnabled="{Binding LatestActivePackage.UpdateCancelEnabled}" />
                                <!-- <button:CButton Content="{Binding LatestActivePackage.UpdateButtonText}" Command="{Binding LatestActivePackage.UpdateToggleCommand}" Width="80" Margin="0,0,8,0" IsEnabled="{Binding LatestActivePackage.UpdateCancelEnabled}" /> -->
                                <button:CButton Content="仅下载" Command="{Binding LatestActivePackage.DownloadOnlyCommand}" Width="80" Margin="0,0,8,0" IsEnabled="{Binding LatestActivePackage.DownloadOnlyEnabled}" />
                                <button:CButton Content="打开Revit" Command="{Binding LatestActivePackage.OpenPathCommand}" Width="100" Margin="0,0,8,0" IsEnabled="{Binding LatestActivePackage.IsEnabled}" />
                                <button:CButton Content="切换配置" Command="{Binding LatestActivePackage.ChangeConfigPresetCommand}" Width="80" IsEnabled="{Binding LatestActivePackage.ConfigOpsEnabled}" />
                                <button:CDangerButton Content="定版" Width="80" Margin="8,0,0,0" Click="FinalizeButton_Click" IsEnabled="{Binding LatestActivePackage.FinalizeButtonEnabled}"/>
                            </StackPanel>
                            <StackPanel Orientation="Horizontal" Margin="0,16,0,0">
                                <button:CButton Content="参数目录" Command="{Binding LatestActivePackage.OpenParameterConfigCommand}" Width="80" Margin="0,0,8,0" IsEnabled="{Binding LatestActivePackage.ConfigOpsEnabled}" />
                                <button:CButton Content="调试选项" Command="{Binding LatestActivePackage.OpenDebugOptionsCommand}" Width="80" Margin="0,0,8,0" IsEnabled="{Binding LatestActivePackage.ConfigOpsEnabled}" />
                                <button:CButton Content="{Binding LatestActivePackage.SignatureToggleText}" Command="{Binding LatestActivePackage.SignatureToggleCommand}" Width="100" IsEnabled="{Binding LatestActivePackage.SignatureCancelEnabled}" />
                                <button:CButton Content="CSV加解密" Width="100" Margin="0,0,8,0" Click="OpenCsvCryptoWindowButton_Click"/>
                                <button:CButton Content="DNS" Width="80" Margin="0,0,8,0" Click="OpenDnsSettingsWindowButton_Click" IsEnabled="{Binding LatestActivePackage.IsTeamworkMasterDevelop}"/>
                            </StackPanel>
                            
                            </StackPanel>
                    </StackPanel>
                </ScrollViewer>

                <!-- 底部进度条（非吸顶） -->
                <StackPanel Grid.Row="2" Orientation="Vertical" Margin="12,0,12,12">
                    <controls:CProgressBar Minimum="0" Maximum="100" Value="{Binding LatestActivePackage.Progress}" Height="16"/>
                </StackPanel>
            </Grid>
        </Border>
    </Grid>
</Page>
